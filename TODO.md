# TODO: Остаток MUST HAVE

Документ описывает, что **осталось сделать** или **сделано с ограничениями** для выполнения всех требований секции MUST HAVE из [технического задания](https://wiki.mtlprog.xyz/ru/project/stat).

---

## Сделано с ограничениями

### 1. I55 — Цена акции год назад (`Price Year Ago`)

**Статус**: Реализовано, но работает только если MTL присутствует как токен в портфеле хотя бы одного аккаунта фонда.

**Проблема**: I10 (рыночная цена MTL) вычисляется live-запросом к orderbook Horizon и **не сохраняется** в снимке. Сохраняются только `PriceInEURMTL` токенов из портфелей аккаунтов. Текущая реализация (`findMTLPrice` в `dividend.go`) сканирует токены снимка годичной давности в поиске MTL — аналогично тому, как `findBTCPrice` в `layer0.go` находит цену BTC.

**Риск**: Если ни один аккаунт фонда не держит MTL как токен в портфеле (например, MTL не участвует в pathfinding для оценки), `findMTLPrice` вернёт 0. Нужно проверить: появляется ли MTL в `FundAccountPortfolio.Tokens` хотя бы одного аккаунта на практике.

**Возможные решения**:
- Добавить I10 в `FundStructureData` при генерации снимка — тогда историческая цена будет точной.
- Или: при генерации снимка отдельно сохранять вычисленные значения ключевых индикаторов (I10, I5 и др.) рядом с сырыми данными.

**Файл**: `internal/indicator/dividend.go`, функция `fetchPriceYearAgo`.

---

### 2. I54 — Годовые дивиденды на акцию (`Annual DPS`)

**Статус**: Реализовано как `I15 × 12` (аннуализация текущего месячного DPS), а не как сумма 12 месяцев.

**Проблема**: Правильная формула — сумма I15 за каждый из последних 12 месяцев из исторических снимков. Для этого нужно:
1. Для каждого из 12 месяцев знать I5 (суммарный объём акций на тот момент) — берётся из снимка.
2. Знать I11 (дивиденды) **за тот конкретный месяц** — требует Horizon-запроса с историческими датами (`since = date - 30d, until = date`). Horizon API поддерживает фильтрацию по времени через курсор, но это нетривиальная реализация с 12 последовательными запросами.

Текущая аппроксимация `I15 × 12` занижает Annual DPS в месяцы с высокими дивидендами и завышает в «тихие» месяцы.

**Что нужно**: Расширить `FetchMonthlyEURMTLOutflow` в `horizon/payments.go`, чтобы принимать не только `since`, но и `until`. Затем в `DividendCalculator` запрашивать I11 за каждый из 12 предыдущих месяцев, используя соответствующие `since/until`.

**Файлы**: `internal/horizon/payments.go`, `internal/indicator/dividend.go`.

---

### 3. I27 — Холдеры MTL и MTLRECT (`MTL Shareholders >=1`)

**Статус**: Реализовано как сумма холдеров MTL + холдеров MTLRECT. Возможен двойной счёт.

**Проблема**: `FetchAssetHolders` возвращает `num_accounts` из `/assets` — количество аккаунтов с ненулевым балансом для каждого актива отдельно. Объединение (union) без дублирования невозможно просто по двум числам: аккаунты, держащие и MTL, и MTLRECT, считаются дважды.

Точный подсчёт требует полного сканирования всех держателей через `/accounts?asset=MTL:...` и `/accounts?asset=MTLRECT:...` с пагинацией, а затем дедупликации по адресу. Это тысячи записей и секунды запросов.

**Текущее поведение**: I27 = count(MTL holders) + count(MTLRECT holders). Если значительная часть держателей имеет оба актива — I27 завышен, что занижает производные I21 (Average Shareholding) и I22 (Average Value per Shareholder).

**Возможные решения**:
- Принять текущую аппроксимацию, уточнить у заказчика насколько критична точность.
- Реализовать полное сканирование + дедупликацию (долгая операция, нужно кэширование).
- Считать только MTL holders (без MTLRECT) — если MTLRECT держат только те, кто уже есть в MTL.

**Файл**: `internal/indicator/tokenomics.go`.

---

### 4. API сравнения (`?compare=30d`)

**Статус**: Реализовано, но для live-индикаторов сравнение всегда показывает ~0 изменений.

**Проблема**: При вычислении исторических индикаторов для сравнения используется тот же `indicator.Service`, который делает живые Horizon-запросы. В результате:
- **I6, I7** (обращение токенов) — берутся из Horizon live, одинаковы для «сейчас» и «N дней назад» → delta = ~0
- **I10** (рыночная цена MTL) — live orderbook → delta = ~0
- **I11** (дивиденды за месяц) — live запрос последних 30 дней → delta = ~0
- **I24, I27, I40** (количество холдеров) — live → delta = ~0

Реально работает (показывает настоящую разницу) только для индикаторов, вычисляемых из сохранённых данных снимка: **I3, I4, I5, I51–I61** и производные от них **I1, I2, I8, I30**.

**Возможное решение**: При вычислении исторических индикаторов передавать `hist = nil`, чтобы выключить рекурсивные исторические запросы, но это не решит проблему live-запросов Horizon. Полное решение — добавить в `FundStructureData` или в снимок вычисленные значения live-индикаторов в момент генерации снимка.

**Файлы**: `internal/api/indicators.go`, `internal/indicator/service.go`.

---

### 5. I11 — Объём дивидендов за месяц (`Monthly Dividends`)

**Статус**: Реализовано, но критерий «дивиденд» не верифицирован с заказчиком.

**Проблема**: Текущая реализация считает **все** исходящие EURMTL-платежи с аккаунта MAIN ISSUER на адреса вне фонда за последние 30 дней. Это может включать:
- Оплату услуг/контрактов
- Возвраты
- Любые операционные переводы в EURMTL

Пока заказчик не подтвердил, что дивиденды действительно отправляются именно с MAIN ISSUER и именно таким образом, значение I11 может быть некорректным.

**Что нужно уточнить**: С каких аккаунтов и по какому признаку (memo, конкретный адрес назначения, сумма) можно однозначно идентифицировать дивидендный платёж?

**Файл**: `internal/horizon/payments.go`, `internal/indicator/dividend.go`.

---

## Не реализовано

### 6. I16 — Annual Dividend Yield 1 (`ADY1`)

**Статус**: Заглушка, всегда возвращает 0. Формула не определена.

**Блокирует**: Ничего критичного (I17 — ADY2 — считается по другой формуле и уже работает).

**Что нужно**: Уточнить у заказчика формулу из `mtlf_indicators.xlsx`. Реализовать в `internal/indicator/dividend.go`, переменная `i16`.

---

### 7. Фронтенд / Дашборд

**Статус**: Backend API готов. Фронтенд находится в репозитории [dreadnought](https://github.com/mtlprog/dreadnought/tree/master/apps/stat.mtlf.me).

**Требования MVP для фронтенда** (реализуются в dreadnought):
- [ ] Главный дашборд с приоритетными индикаторами
- [ ] Табы/вкладки для переключения между группами показателей
- [ ] Колонка динамики через `?compare=30d` — значения `change_abs` и `change_pct`
- [ ] При отсутствии исторических данных — метка "н/д" (API возвращает поля без `change_abs`/`change_pct`)
- [ ] Ссылки на аккаунты → viewer.eurmtl.me или Stellar Expert
- [ ] Сравнение за периоды: месяц, квартал, полгода, год

---

## Открытые вопросы (требуют ответа заказчика)

1. **Критерий дивидендных платежей** — как отличить дивиденды от операционных переводов в истории платежей Horizon? С каких аккаунтов и по какому признаку (memo, адрес, сумма)?
2. **Формула I16 (ADY1)** — в коде заглушка. В `mtlf_indicators.xlsx` должна быть формула — уточнить.
3. **Точность I27** — насколько критичен двойной счёт холдеров MTL+MTLRECT? Нужна ли точная дедупликация или достаточно текущей аппроксимации?
4. **Рекурсивный учёт ПИФов** (MFApart, MFBond) — фонд владеет ими не на 100%, нужна логика пропорционального учёта. Сейчас берётся 100% стоимости.
